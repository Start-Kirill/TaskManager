package by.it_academy.user_service.endpoints.web.controllers;

import by.it_academy.user_service.core.dto.CustomPage;
import by.it_academy.user_service.core.dto.UserCreateDto;
import by.it_academy.user_service.core.dto.UserDto;
import by.it_academy.user_service.dao.entity.User;
import by.it_academy.user_service.service.api.IUserService;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Min;
import org.springframework.beans.BeanUtils;
import org.springframework.core.convert.ConversionService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/users")
@Validated
public class UserController {

    private static final String CONTENT_FIELD_NAME = "content";

    private IUserService userService;

    private ConversionService conversionService;


    public UserController(IUserService userService, ConversionService conversionService) {
        this.userService = userService;
        this.conversionService = conversionService;
    }

    @PostMapping
    public ResponseEntity<?> create(@RequestBody @Valid UserCreateDto dto) {
        this.userService.save(dto);
        return new ResponseEntity<>(HttpStatus.CREATED);
    }

    @PutMapping("/{uuid}/dt_update/{dt_update}")
    public ResponseEntity<?> update(@RequestBody UserCreateDto dto, @PathVariable UUID uuid, @PathVariable(name = "dt_update") LocalDateTime dtUpdate) {
        this.userService.update(dto, uuid, dtUpdate);
        return new ResponseEntity<>(HttpStatus.OK);
    }

    @GetMapping
    public ResponseEntity<?> get(@RequestParam(required = false, defaultValue = "0") @Min(value = 0, message = "Page must be positive value") Integer page,
                                 @RequestParam(required = false, defaultValue = "20") @Min(value = 1, message = "Size must not be less than one") Integer size) {
        CustomPage<User> userCustomPage = this.userService.get(page, size);
        CustomPage<UserDto> userDtoCustomPage = new CustomPage<>();
        BeanUtils.copyProperties(userCustomPage, userDtoCustomPage, CONTENT_FIELD_NAME);
        List<User> content = userCustomPage.getContent();
        List<UserDto> userDtos = content.stream().map(u -> this.conversionService.convert(u, UserDto.class)).toList();
        userDtoCustomPage.setContent(userDtos);
        return ResponseEntity.status(HttpStatus.OK).body(userDtoCustomPage);
    }

    @GetMapping("/{uuid}")
    public ResponseEntity<?> getUser(@PathVariable UUID uuid) {
        User user = this.userService.get(uuid);
        UserDto userDto = this.conversionService.convert(user, UserDto.class);
        return ResponseEntity.status(HttpStatus.OK).body(userDto);
    }

}








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































