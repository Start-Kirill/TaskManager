package by.it_academy.user_service.endpoints.web.controllers;

import by.it_academy.task_manager_common.dto.CustomPage;
import by.it_academy.task_manager_common.dto.UserDto;
import by.it_academy.user_service.core.dto.UserCreateDto;
import by.it_academy.user_service.dao.entity.User;
import by.it_academy.user_service.service.api.IUserService;
import org.springframework.beans.BeanUtils;
import org.springframework.core.convert.ConversionService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Set;
import java.util.UUID;

@RestController
@RequestMapping("/users")
public class UserController {

    private static final String TOPIC_USER_REQUEST = "user_request";

    private static final String TOPIC_USER_RESPONSE = "user_response";

    private static final String CONTENT_FIELD_NAME = "content";

    private final IUserService userService;

    private final ConversionService conversionService;

    private final KafkaTemplate<String, UserDto> kafkaUserTemplate;


    public UserController(IUserService userService,
                          ConversionService conversionService,
                          KafkaTemplate<String, UserDto> kafkaUserTemplate) {
        this.userService = userService;
        this.conversionService = conversionService;
        this.kafkaUserTemplate = kafkaUserTemplate;
    }

    @PostMapping
    public ResponseEntity<?> create(@RequestBody UserCreateDto dto) {
        this.userService.saveByUser(dto);
        return new ResponseEntity<>(HttpStatus.CREATED);
    }

    @PutMapping("/{uuid}/dt_update/{dt_update}")
    public ResponseEntity<?> update(@RequestBody UserCreateDto dto, @PathVariable UUID uuid, @PathVariable(name = "dt_update") LocalDateTime dtUpdate) {
        this.userService.update(dto, uuid, dtUpdate);
        return new ResponseEntity<>(HttpStatus.OK);
    }

    @GetMapping
    public ResponseEntity<?> get(@RequestParam(required = false, defaultValue = "0") Integer page,
                                 @RequestParam(required = false, defaultValue = "20") Integer size) {
        CustomPage<User> userCustomPage = this.userService.get(page, size);
        CustomPage<UserDto> userDtoCustomPage = new CustomPage<>();
        BeanUtils.copyProperties(userCustomPage, userDtoCustomPage, CONTENT_FIELD_NAME);
        List<User> content = userCustomPage.getContent();
        List<UserDto> userDtos = content.stream().map(u -> this.conversionService.convert(u, UserDto.class)).toList();
        userDtoCustomPage.setContent(userDtos);
        return ResponseEntity.status(HttpStatus.OK).body(userDtoCustomPage);
    }

    @GetMapping("/{uuid}")
    public ResponseEntity<?> getUser(@PathVariable UUID uuid) {
        User user = this.userService.get(uuid);
        UserDto userDto = this.conversionService.convert(user, UserDto.class);
        return ResponseEntity.status(HttpStatus.OK).body(userDto);
    }

    @PatchMapping
    public ResponseEntity<?> getUsers(@RequestBody Set<UUID> users) {
        List<User> userList = this.userService.findAllByUuid(users);
        List<UserDto> userDtos = userList.stream().map(u -> this.conversionService.convert(u, UserDto.class)).toList();
        return ResponseEntity.status(HttpStatus.OK).body(userDtos);
    }

    @KafkaListener(topics = TOPIC_USER_REQUEST)
    public void userRequestListener(UUID uuid) {
        User user = this.userService.get(uuid);
        UserDto userDto = this.conversionService.convert(user, UserDto.class);
        this.kafkaUserTemplate.send(TOPIC_USER_RESPONSE, userDto);
    }

}








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































